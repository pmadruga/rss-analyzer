name: ðŸ§ª PR Quality Checks

on:
  pull_request:
    branches: [main, develop]
    paths:
      - '**.py'
      - 'requirements.txt'
      - 'pyproject.toml'
      - 'tests/**'

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  # Run tests
  tests:
    name: ðŸ§ª Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ”„ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: âš¡ Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"

      - name: ðŸ“¦ Install dependencies
        run: uv sync

      - name: ðŸ§ª Run unit tests
        run: |
          uv run pytest tests/ -v --cov=src --cov-report=term --cov-report=xml

      - name: ðŸ“Š Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          flags: unittests
          name: codecov-umbrella

  # Type checking
  type-check:
    name: ðŸ” Type Checking
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ”„ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: âš¡ Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"

      - name: ðŸ“¦ Install dependencies
        run: |
          uv sync
          uv pip install mypy types-requests types-PyYAML

      - name: ðŸ” Run mypy
        run: |
          uv run mypy src/ --ignore-missing-imports --show-error-codes

  # Linting
  lint:
    name: ðŸŽ¨ Code Linting
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ”„ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: âš¡ Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"

      - name: ðŸ“¦ Install dependencies
        run: |
          uv sync
          uv pip install ruff

      - name: ðŸŽ¨ Run ruff
        run: |
          uv run ruff check src/ tests/

  # Security scan
  security-scan:
    name: ðŸ”’ Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ”„ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: âš¡ Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"

      - name: ðŸ“¦ Install dependencies
        run: |
          uv sync
          uv pip install bandit safety

      - name: ðŸ”’ Run Bandit
        run: |
          uv run bandit -r src/ -f json -o bandit-report.json || true

      - name: ðŸ”’ Run Safety
        run: |
          uv run safety check --json > safety-report.json || true

      - name: ðŸ“Š Upload security reports
        uses: actions/upload-artifact@v3
        with:
          name: security-reports
          path: |
            bandit-report.json
            safety-report.json

  # Code coverage check
  coverage:
    name: ðŸ“Š Coverage Check
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ”„ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: âš¡ Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"

      - name: ðŸ“¦ Install dependencies
        run: uv sync

      - name: ðŸ“Š Run coverage
        run: |
          uv run pytest tests/ --cov=src --cov-report=term --cov-report=html --cov-fail-under=80

      - name: ðŸ“Š Upload coverage report
        uses: actions/upload-artifact@v3
        with:
          name: coverage-report
          path: htmlcov/

  # Import validation
  import-check:
    name: ðŸ”¬ Import Validation
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ”„ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: âš¡ Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"

      - name: ðŸ“¦ Install dependencies
        run: uv sync

      - name: ðŸ”¬ Validate imports
        run: |
          uv run python tools/validate_imports.py

  # Docker build test
  docker-build:
    name: ðŸ³ Docker Build Test
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ”„ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ³ Build Docker image
        run: |
          docker compose build rss-analyzer

      - name: ðŸ§ª Test Docker container
        run: |
          docker compose run rss-analyzer python -c "import src.main; print('âœ… Import successful')"

  # Summary
  checks-summary:
    name: ðŸ“Š Checks Summary
    needs: [tests, type-check, lint, security-scan, coverage, import-check, docker-build]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ”§ Setup GitHub CLI
        run: echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: ðŸ“Š Generate summary
        run: |
          PR_NUM=${{ github.event.pull_request.number }}

          REPO="${{ github.repository }}"

          TESTS="${{ needs.tests.result }}"
          TYPE_CHECK="${{ needs.type-check.result }}"
          LINT="${{ needs.lint.result }}"
          SECURITY="${{ needs.security-scan.result }}"
          COVERAGE="${{ needs.coverage.result }}"
          IMPORTS="${{ needs.import-check.result }}"
          DOCKER="${{ needs.docker-build.result }}"

          # Determine overall status
          if [ "$TESTS" = "failure" ] || [ "$TYPE_CHECK" = "failure" ] || [ "$LINT" = "failure" ]; then
            OVERALL="ðŸ”´ Some checks failed"
            STATUS_ICON="âŒ"
          elif [ "$COVERAGE" = "failure" ]; then
            OVERALL="ðŸŸ¡ Coverage below threshold"
            STATUS_ICON="âš ï¸"
          else
            OVERALL="ðŸŸ¢ All checks passed"
            STATUS_ICON="âœ…"
          fi

          cat > summary.md << EOF
          ## ðŸ§ª Quality Checks Summary

          $STATUS_ICON **$OVERALL**

          | Check | Status |
          |-------|--------|
          | ðŸ§ª Tests | $([ "$TESTS" = "success" ] && echo "âœ…" || echo "âŒ") |
          | ðŸ” Type Check | $([ "$TYPE_CHECK" = "success" ] && echo "âœ…" || echo "âŒ") |
          | ðŸŽ¨ Linting | $([ "$LINT" = "success" ] && echo "âœ…" || echo "âŒ") |
          | ðŸ”’ Security | $([ "$SECURITY" = "success" ] && echo "âœ…" || echo "âš ï¸") |
          | ðŸ“Š Coverage | $([ "$COVERAGE" = "success" ] && echo "âœ…" || echo "âš ï¸") |
          | ðŸ”¬ Imports | $([ "$IMPORTS" = "success" ] && echo "âœ…" || echo "âŒ") |
          | ðŸ³ Docker | $([ "$DOCKER" = "success" ] && echo "âœ…" || echo "âŒ") |

          ---

          ### Next Steps:

          EOF

          if [ "$OVERALL" = "ðŸ”´ Some checks failed" ]; then
            echo "1. âŒ Fix failing checks before requesting review" >> summary.md
            echo "2. ðŸ” Review detailed logs for each failing check" >> summary.md
            echo "3. âœ… Re-run checks after fixes" >> summary.md
          elif [ "$OVERALL" = "ðŸŸ¡ Coverage below threshold" ]; then
            echo "1. âš ï¸ Consider adding more tests to improve coverage" >> summary.md
            echo "2. ðŸ‘¥ You can still request review if coverage drop is justified" >> summary.md
          else
            echo "1. âœ… All automated checks passed!" >> summary.md
            echo "2. ðŸ¤– Wait for AI code review" >> summary.md
            echo "3. ðŸ‘¥ Request human review when ready" >> summary.md
          fi

          echo "" >> summary.md
          echo "---" >> summary.md
          echo "*Automated quality checks by GitHub Actions*" >> summary.md

          gh pr comment $PR_NUM --repo $REPO --body-file summary.md
