name: Test Pipeline Components

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      test_level:
        description: 'Test level: basic, imports, or full'
        required: false
        default: 'imports'
        type: choice
        options:
        - basic
        - imports
        - full

env:
  API_PROVIDER: 'mistral'
  MISTRAL_API_KEY: ${{ secrets.MISTRAL_API_KEY }}
  MAX_ARTICLES_PER_RUN: 1
  FOLLOW_LINKS: false

jobs:
  test-components:
    runs-on: ubuntu-latest
    steps:
    - name: 🔄 Checkout repository
      uses: actions/checkout@v4

    - name: 🐍 Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: ⚡ Install uv
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"

    - name: 📦 Install dependencies
      run: |
        uv sync

    - name: 🔬 Test imports and dependencies
      run: |
        echo "🔬 Testing all imports and dependencies..."
        uv run python tools/validate_imports.py

    - name: 🔍 Test RSS parsing
      if: github.event.inputs.test_level != 'basic'
      run: |
        echo "🔍 Testing RSS feed connectivity..."
        uv run python -c "
        from src.rss_parser import RSSParser
        parser = RSSParser()
        entries = parser.fetch_feed('https://bg.raindrop.io/rss/public/57118738')
        print(f'✅ RSS parsing test: Found {len(entries)} entries')
        "

    - name: 🌐 Test web scraping
      if: github.event.inputs.test_level != 'basic'
      run: |
        echo "🌐 Testing web scraping..."
        uv run python -c "
        from src.scraper import WebScraper
        scraper = WebScraper()
        result = scraper.scrape_article('https://jina.ai/news/quantization-aware-training-of-jina-embeddings-v4/', follow_links=False)
        print(f'✅ Scraper test: {\"Success\" if result else \"Failed\"}')
        if result:
            print(f'   Content length: {len(result.content)} characters')
        "

    - name: 🗄️ Test database operations
      if: github.event.inputs.test_level != 'basic'
      run: |
        echo "🗄️ Testing database..."
        uv run python -c "
        from src.database import DatabaseManager
        db = DatabaseManager('test.db')
        print('✅ Database test: Initialized successfully')
        "

    - name: 🧪 Test full pipeline (1 article)
      if: github.event.inputs.test_level == 'full'
      run: |
        echo "🧪 Running full pipeline test with 1 article..."
        mkdir -p data logs output
        uv run python -m src.main run --limit 1 --log-level DEBUG || {
          echo "❌ Pipeline test failed"
          if [ -d "logs" ]; then
            echo "📁 Available logs:"
            find logs -name "*.log" -exec echo "=== {} ===" \; -exec cat {} \;
          fi
          exit 1
        }

    - name: 📊 Test summary
      if: always()
      run: |
        if [ "${{ job.status }}" = "success" ]; then
          echo "✅ All pipeline component tests passed!"
        else
          echo "❌ Some pipeline component tests failed!"
        fi
        echo "Test level: ${{ github.event.inputs.test_level || 'imports' }}"
